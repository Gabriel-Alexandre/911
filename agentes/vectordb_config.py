"""
Configura√ß√µes da base vetorial FAISS para sistema de emerg√™ncia 911.
FAISS √© um banco vetorial simples, r√°pido e confi√°vel.
"""

import os
import pickle
import time
from datetime import datetime
from typing import Optional, List, Dict, Any
from dotenv import load_dotenv

# Importa√ß√µes do LangChain para FAISS
from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import FAISS
from langchain.schema import Document

load_dotenv()

class VectorDBConfig:
    """Configura√ß√µes para a base vetorial FAISS."""
    
    # Configura√ß√µes via vari√°veis de ambiente
    FAISS_INDEX_PATH = os.getenv("FAISS_INDEX_PATH", "./faiss_db")
    COLLECTION_NAME = os.getenv("COLLECTION_NAME", "emergency_knowledge")
    
    def __init__(self):
        """Inicializa as configura√ß√µes da base vetorial."""
        # Cria diret√≥rio se n√£o existir
        os.makedirs(self.FAISS_INDEX_PATH, exist_ok=True)
        self.index_file = os.path.join(self.FAISS_INDEX_PATH, f"{self.COLLECTION_NAME}.faiss")
        self.pkl_file = os.path.join(self.FAISS_INDEX_PATH, f"{self.COLLECTION_NAME}.pkl")
        
    def get_embeddings(self) -> OpenAIEmbeddings:
        """
        Retorna o modelo de embeddings OpenAI.
        
        Returns:
            OpenAIEmbeddings: Modelo de embeddings configurado
        """
        return OpenAIEmbeddings(
            model="text-embedding-3-small",
            chunk_size=1000
        )
    
    def get_vector_store(self, embeddings: Optional[OpenAIEmbeddings] = None) -> FAISS:
        """
        Retorna o vector store FAISS configurado.
        
        Args:
            embeddings: Modelo de embeddings a ser usado (OpenAI por padr√£o)
            
        Returns:
            FAISS: Vector store configurado
        """
        if embeddings is None:
            embeddings = self.get_embeddings()
        
        # Verifica se j√° existe um √≠ndice salvo
        if os.path.exists(self.index_file) and os.path.exists(self.pkl_file):
            try:
                # Carrega √≠ndice existente
                vector_store = FAISS.load_local(
                    self.FAISS_INDEX_PATH, 
                    embeddings, 
                    self.COLLECTION_NAME,
                    allow_dangerous_deserialization=True
                )
                return vector_store
            except Exception as e:
                print(f"‚ö†Ô∏è Erro ao carregar √≠ndice existente: {e}")
                print("üîÑ Criando novo √≠ndice...")
        
        # Cria novo √≠ndice vazio
        # Cria com um documento dummy para inicializar
        dummy_doc = Document(
            page_content="Documento inicial para configura√ß√£o do sistema 911",
            metadata={"tipo": "sistema", "categoria": "inicial"}
        )
        
        vector_store = FAISS.from_documents([dummy_doc], embeddings)
        
        # Salva o √≠ndice
        self.save_vector_store(vector_store)
        
        return vector_store
    
    def save_vector_store(self, vector_store: FAISS) -> bool:
        """
        Salva o vector store no disco.
        
        Args:
            vector_store: Vector store a ser salvo
            
        Returns:
            bool: True se salvou com sucesso
        """
        try:
            vector_store.save_local(self.FAISS_INDEX_PATH, self.COLLECTION_NAME)
            print(f"‚úÖ √çndice salvo em: {self.FAISS_INDEX_PATH}")
            return True
        except Exception as e:
            print(f"‚ùå Erro ao salvar √≠ndice: {e}")
            return False
    
    def add_documents(self, documents: List[Document], vector_store: Optional[FAISS] = None) -> bool:
        """
        Adiciona documentos ao vector store.
        
        Args:
            documents: Lista de documentos a serem adicionados
            vector_store: Vector store existente (opcional)
            
        Returns:
            bool: True se adicionou com sucesso
        """
        try:
            if vector_store is None:
                vector_store = self.get_vector_store()
            
            # Adiciona documentos
            vector_store.add_documents(documents)
            
            # Salva altera√ß√µes
            self.save_vector_store(vector_store)
            
            print(f"‚úÖ {len(documents)} documentos adicionados com sucesso")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao adicionar documentos: {e}")
            return False
    
    def add_texts(self, texts: List[str], metadatas: Optional[List[Dict]] = None) -> bool:
        """
        Adiciona textos ao vector store.
        
        Args:
            texts: Lista de textos a serem adicionados
            metadatas: Lista de metadados (opcional)
            
        Returns:
            bool: True se adicionou com sucesso
        """
        try:
            vector_store = self.get_vector_store()
            
            # Adiciona textos
            vector_store.add_texts(texts, metadatas=metadatas)
            
            # Salva altera√ß√µes
            self.save_vector_store(vector_store)
            
            print(f"‚úÖ {len(texts)} textos adicionados com sucesso")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao adicionar textos: {e}")
            return False
    
    def search_documents(self, query: str, k: int = 5) -> List[Document]:
        """
        Busca documentos similares.
        
        Args:
            query: Texto de busca
            k: N√∫mero de documentos a retornar
            
        Returns:
            List[Document]: Lista de documentos encontrados
        """
        try:
            vector_store = self.get_vector_store()
            results = vector_store.similarity_search(query, k=k)
            return results
        except Exception as e:
            print(f"‚ùå Erro na busca: {e}")
            return []
    
    def search_with_score(self, query: str, k: int = 5) -> List[tuple]:
        """
        Busca documentos similares com pontua√ß√£o.
        
        Args:
            query: Texto de busca
            k: N√∫mero de documentos a retornar
            
        Returns:
            List[tuple]: Lista de tuplas (documento, score)
        """
        try:
            vector_store = self.get_vector_store()
            results = vector_store.similarity_search_with_score(query, k=k)
            return results
        except Exception as e:
            print(f"‚ùå Erro na busca com score: {e}")
            return []
    
    def get_index_stats(self) -> Dict[str, Any]:
        """
        Retorna estat√≠sticas do √≠ndice.
        
        Returns:
            Dict: Estat√≠sticas do √≠ndice
        """
        try:
            vector_store = self.get_vector_store()
            
            # FAISS n√£o tem m√©todo direto para contagem, mas podemos inferir
            stats = {
                "index_file_exists": os.path.exists(self.index_file),
                "pkl_file_exists": os.path.exists(self.pkl_file),
                "index_path": self.FAISS_INDEX_PATH,
                "collection_name": self.COLLECTION_NAME,
                "index_file_size": os.path.getsize(self.index_file) if os.path.exists(self.index_file) else 0,
                "pkl_file_size": os.path.getsize(self.pkl_file) if os.path.exists(self.pkl_file) else 0
            }
            
            return stats
            
        except Exception as e:
            print(f"‚ùå Erro ao obter estat√≠sticas: {e}")
            return {}
    
    def reset_index(self) -> bool:
        """
        Reseta o √≠ndice, removendo todos os documentos.
        
        Returns:
            bool: True se resetou com sucesso
        """
        try:
            # Remove arquivos do √≠ndice
            if os.path.exists(self.index_file):
                os.remove(self.index_file)
            if os.path.exists(self.pkl_file):
                os.remove(self.pkl_file)
            
            print("‚úÖ √çndice resetado com sucesso")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao resetar √≠ndice: {e}")
            return False
    
    def test_connection(self) -> bool:
        """
        Testa a conex√£o com a base vetorial.
        
        Returns:
            bool: True se conex√£o bem-sucedida
        """
        try:
            # Testa cria√ß√£o do vector store
            vector_store = self.get_vector_store()
            
            # Testa busca simples
            results = vector_store.similarity_search("teste de conex√£o", k=1)
            
            print("‚úÖ Conex√£o com FAISS estabelecida com sucesso")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro na conex√£o: {e}")
            return False
    
    def test_embeddings(self) -> bool:
        """
        Testa se os embeddings OpenAI est√£o funcionando.
        
        Returns:
            bool: True se embeddings est√£o funcionando
        """
        try:
            embeddings = self.get_embeddings()
            
            # Testa com um texto simples
            test_text = "Emerg√™ncia m√©dica: paciente com dor no peito"
            result = embeddings.embed_query(test_text)
            
            if result and len(result) > 0:
                print(f"‚úÖ Embeddings funcionando! Dimens√£o: {len(result)}")
                return True
            else:
                print("‚ùå Embeddings n√£o retornaram resultado v√°lido")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro nos embeddings: {e}")
            return False
    
    def test_vector_store_operations(self) -> bool:
        """
        Testa opera√ß√µes b√°sicas do vector store (inser√ß√£o e busca).
        
        Returns:
            bool: True se todas as opera√ß√µes funcionaram
        """
        try:
            # Dados de teste
            test_texts = [
                "Emerg√™ncia m√©dica: paciente com dor no peito aguda",
                "Inc√™ndio em resid√™ncia: bombeiros necess√°rios urgentemente",
                "Acidente de tr√¢nsito: feridos graves na rodovia",
                "Assalto em andamento: suspeito armado"
            ]
            
            test_metadatas = [
                {"categoria": "medica", "prioridade": "alta"},
                {"categoria": "incendio", "prioridade": "alta"},
                {"categoria": "transito", "prioridade": "media"},
                {"categoria": "criminal", "prioridade": "alta"}
            ]
            
            # Obt√©m o vector store
            vector_store = self.get_vector_store()
            
            # Testa inser√ß√£o
            print("üîÑ Testando inser√ß√£o de textos...")
            vector_store.add_texts(texts=test_texts, metadatas=test_metadatas)
            self.save_vector_store(vector_store)
            print("‚úÖ Textos inseridos com sucesso!")
            
            # Testa busca
            print("üîÑ Testando busca de documentos...")
            results = vector_store.similarity_search(query="dor no peito", k=2)
            
            if results and len(results) > 0:
                print(f"‚úÖ Busca funcionando! Encontrados {len(results)} documentos")
                for i, doc in enumerate(results):
                    print(f"   {i+1}. {doc.page_content[:50]}...")
                return True
            else:
                print("‚ùå Busca n√£o retornou resultados")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro nas opera√ß√µes: {e}")
            return False
    
    def run_full_test_suite(self) -> bool:
        """
        Executa suite completa de testes para verificar se tudo est√° funcionando.
        
        Returns:
            bool: True se todos os testes passaram
        """
        print("üöÄ Iniciando suite completa de testes do FAISS...")
        print("=" * 60)
        
        # Lista de testes
        tests = [
            ("Teste de embeddings OpenAI", self.test_embeddings),
            ("Teste de conex√£o FAISS", self.test_connection),
            ("Teste de opera√ß√µes do vector store", self.test_vector_store_operations),
            ("Verifica√ß√£o de estat√≠sticas", self.get_index_stats)
        ]
        
        results = []
        
        for test_name, test_func in tests:
            print(f"\nüîç Executando teste: {test_name}")
            print("-" * 40)
            
            start_time = time.time()
            try:
                if test_name == "Verifica√ß√£o de estat√≠sticas":
                    result = test_func()
                    success = bool(result)
                    if success:
                        print("‚úÖ Estat√≠sticas obtidas:")
                        for key, value in result.items():
                            print(f"   {key}: {value}")
                else:
                    success = test_func()
                
                elapsed_time = time.time() - start_time
                
                if success:
                    print(f"‚úÖ {test_name} - PASSOU ({elapsed_time:.2f}s)")
                else:
                    print(f"‚ùå {test_name} - FALHOU ({elapsed_time:.2f}s)")
                
                results.append((test_name, success, elapsed_time))
                
            except Exception as e:
                elapsed_time = time.time() - start_time
                print(f"‚ùå {test_name} - ERRO: {e} ({elapsed_time:.2f}s)")
                results.append((test_name, False, elapsed_time))
        
        # Resumo final
        print("\n" + "=" * 60)
        print("üìã RESUMO DOS TESTES")
        print("=" * 60)
        
        passed = sum(1 for _, result, _ in results if result)
        total = len(results)
        
        for test_name, result, elapsed_time in results:
            status = "‚úÖ PASSOU" if result else "‚ùå FALHOU"
            print(f"{status:<12} {test_name:<35} ({elapsed_time:.2f}s)")
        
        print("-" * 60)
        print(f"Resultados: {passed}/{total} testes passaram")
        
        if passed == total:
            print("üéâ Todos os testes passaram! FAISS funcionando corretamente.")
            return True
        else:
            print("‚ö†Ô∏è  Alguns testes falharam. Verifique as configura√ß√µes.")
            self.provide_troubleshooting_tips()
            return False
    
    def provide_troubleshooting_tips(self) -> None:
        """
        Fornece dicas de solu√ß√£o de problemas se os testes falharem.
        """
        print("\nüîß DICAS DE SOLU√á√ÉO DE PROBLEMAS:")
        print("=" * 50)
        
        print("\n1. üì¶ Instalar depend√™ncias:")
        print("   pip install faiss-cpu langchain-openai langchain-community")
        
        print("\n2. üîë Verificar vari√°veis de ambiente:")
        print("   OPENAI_API_KEY deve estar definida")
        print("   export OPENAI_API_KEY='sua-chave-aqui'")
        
        print("\n3. üóÇÔ∏è Verificar permiss√µes de diret√≥rio:")
        print(f"   Diret√≥rio: {self.FAISS_INDEX_PATH}")
        print("   Certifique-se de que o diret√≥rio tem permiss√µes de escrita")
        
        print("\n4. üßπ Resetar √≠ndice (se necess√°rio):")
        print("   config.reset_index()")
        
        print("\n5. üìä Verificar estat√≠sticas:")
        print("   config.get_index_stats()")
        
        print("\nüí° FAISS √© mais simples que ChromaDB - menos problemas!")

# Fun√ß√£o utilit√°ria para execu√ß√£o r√°pida
def test_vectordb_quick():
    """
    Fun√ß√£o utilit√°ria para teste r√°pido da base vetorial.
    """
    config = VectorDBConfig()
    return config.run_full_test_suite()

# Fun√ß√£o para migra√ß√£o de dados do ChromaDB (se necess√°rio)
def migrate_from_chromadb():
    """
    Fun√ß√£o para migrar dados do ChromaDB para FAISS (se necess√°rio).
    """
    print("üîÑ Migra√ß√£o do ChromaDB para FAISS n√£o implementada")
    print("üí° FAISS √© um novo come√ßo - mais simples e confi√°vel!")
    print("üìù Recarregue seus dados usando config.add_texts() ou config.add_documents()")

if __name__ == "__main__":
    # Executa testes quando o arquivo √© executado diretamente
    success = test_vectordb_quick()
    
    if success:
        print("\nüéâ FAISS funcionando perfeitamente!")
    else:
        print("\n‚ùå Alguns testes falharam. Verifique as configura√ß√µes.")
